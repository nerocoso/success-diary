<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ë„¤ë¡œë´‡ ëŒ€í™”ì°½</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root { --pink:#ff6b9d; --bg:#0a0a0a; --panel: rgba(30,30,30,.85); }
    * { box-sizing: border-box; }
    body { margin:0; background:#000; color:#e0e0e0; font-family:'Inter', system-ui, -apple-system, Segoe UI, Roboto, sans-serif; height:100vh; display:flex; }
    .wrap { margin:auto; width:100%; max-width:680px; height:90vh; display:flex; flex-direction:column; background:var(--panel); border:1px solid rgba(255,107,157,.3); border-radius:18px; box-shadow:0 8px 32px rgba(0,0,0,.45); overflow:hidden; }
    .head { padding:16px 18px; border-bottom:1px solid rgba(255,107,157,.25); display:flex; align-items:center; gap:10px; }
    .head h1 { margin:0; font-size:1.2rem; font-weight:700; color:#fff; text-shadow:0 0 12px #fff; display:flex; align-items:center; gap:8px; }
    .head .spacer { flex:1; }
    .head button { background:transparent; color:#fff; border:1px solid rgba(255,107,157,.35); border-radius:10px; padding:6px 10px; cursor:pointer; }
    .head button:hover { box-shadow:0 0 14px rgba(255,107,157,.35); }

    .msgs { flex:1; padding:16px; overflow-y:auto; background:rgba(20,20,20,.4); }
    .row { display:flex; margin:10px 0; }
    .row.user { justify-content:flex-end; }
    .bubble { max-width:75%; padding:12px 14px; border-radius:12px; border:1px solid rgba(255,107,157,.3); background:rgba(255,107,157,.12); line-height:1.45; font-size:.96rem; }
    .row.user .bubble { background:rgba(135,206,235,.12); border-color:rgba(135,206,235,.35); }
    .bubble i { margin-right:6px; color:var(--pink); }

    .input { display:flex; gap:10px; padding:12px; border-top:1px solid rgba(255,107,157,.25); background:rgba(0,0,0,.25); }
    .input input { flex:1; background:rgba(0,0,0,.45); border:1px solid rgba(255,107,157,.35); border-radius:10px; color:#eaeaea; padding:12px 14px; font-size:.96rem; outline:none; }
    .input button { background: linear-gradient(135deg, #ff6b9d, #87ceeb); border:none; color:#0b0b0b; font-weight:700; border-radius:10px; padding:0 16px; cursor:pointer; }
    .tip { padding:10px 16px; font-size:.85rem; color:#bdbdbd; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="head">
      <h1><i class="fas fa-robot"></i> ë„¤ë¡œë´‡</h1>
      <div class="spacer"></div>
      <button id="closeBtn"><i class="fas fa-xmark"></i> ë‹«ê¸°</button>
    </div>
    <div class="msgs" id="msgs">
      <div class="row bot"><div class="bubble"><i class="fas fa-robot"></i>ì•ˆë…•í•˜ì„¸ìš”! ì €ëŠ” ë„¤ë¡œë´‡ì…ë‹ˆë‹¤. ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?</div></div>
    </div>
    <div class="input">
      <input type="text" id="inp" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”. ì˜ˆ) ìµœê·¼ ì¼ì§€ ìš”ì•½ / ëª©í‘œ í˜„í™© / ë‹¤ìŒ í•  ì¼ ì¶”ì²œ" />
      <button id="send"><i class="fas fa-paper-plane"></i></button>
    </div>
    <div class="tip">ë„ì›€ë§: "í•™ìŠµ: í‚¤ì›Œë“œ=ì»¤í”¼, ì‘ë‹µ=ì»¤í”¼ ì¢‹ì£ !" ì²˜ëŸ¼ ê·œì¹™ì„ ê°€ë¥´ì¹  ìˆ˜ ìˆì–´ìš”.</div>
  </div>

  <script>
    // --- Local assistant copied (lightweight) ---
    function getLocal(key, fallback){ try { return JSON.parse(localStorage.getItem(key)) ?? fallback } catch { return fallback } }
    function setLocal(key, val){ try { localStorage.setItem(key, JSON.stringify(val)) } catch {}
    }

    function getCustomRules(){ return getLocal('nero_custom_rules', []) }
    function saveCustomRules(r){ setLocal('nero_custom_rules', (r||[]).slice(-50)) }
    function addCustomRule(pattern, response){ const r=getCustomRules(); r.push({pattern:String(pattern||'').slice(0,200), response:String(response||'').slice(0,2000)}); saveCustomRules(r); return r.length }
    function clearCustomRules(){ saveCustomRules([]) }

    function generateLocalAssistantResponse(msg){
      const diaries = getLocal('diaries', []);
      const goals = getLocal('goals', []);
      const text = (msg||'').trim();
      if(!text) return 'ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”? ì˜ˆ: "ìµœê·¼ ì¼ì§€ ìš”ì•½", "ëª©í‘œ í˜„í™©", "ë‹¤ìŒ í•  ì¼ ì¶”ì²œ"';
      const lower = text.toLowerCase();
      const now = new Date();
      const todayStr = now.toISOString().split('T')[0];
      const rnd = (a)=>a[Math.floor(Math.random()*a.length)];

      // teach commands
      const teachMatch = text.match(/^\s*(í•™ìŠµ|teach)\s*:\s*(.+)$/i);
      if(teachMatch){
        const rest = teachMatch[2];
        const kv = Object.fromEntries(rest.split(',').map(s=>s.split('=').map(x=>x.trim())).filter(a=>a.length===2));
        const pattern = kv.pattern || kv.í‚¤ì›Œë“œ || kv.key || kv.keyword;
        const response = kv.reply || kv.ì‘ë‹µ || kv.res || kv.response;
        if(!pattern || !response){
          return 'í•™ìŠµ í˜•ì‹: í•™ìŠµ: í‚¤ì›Œë“œ=<ë¬¸êµ¬> , ì‘ë‹µ=<ë‹µë³€>  ë˜ëŠ”  teach: pattern=/ì •ê·œì‹/i , reply=ë‹µë³€';
        }
        const count = addCustomRule(pattern, response);
        return `í•™ìŠµ ì™„ë£Œ! ê·œì¹™ ${count}ê°œ ì €ì¥ë¨. (íŒ¨í„´: ${pattern})`;
      }
      if(/^\s*(í•™ìŠµëª©ë¡|list\s*teach)/i.test(text)){
        const rules=getCustomRules();
        if(!rules.length) return 'ì €ì¥ëœ í•™ìŠµ ê·œì¹™ì´ ì—†ìŠµë‹ˆë‹¤.';
        const lines = rules.slice(-10).map((r,i)=>`${i+1}. íŒ¨í„´: ${r.pattern} â†’ ì‘ë‹µ: ${r.response.slice(0,60)}${r.response.length>60?'â€¦':''}`);
        return `ìµœê·¼ í•™ìŠµ ê·œì¹™(ìµœëŒ€ 10ê°œ):\n${lines.join('\n')}`;
      }
      if(/^\s*(í•™ìŠµì´ˆê¸°í™”|í•™ìŠµ ì´ˆê¸°í™”|clear\s*teach)/i.test(text)){
        clearCustomRules();
        return 'ëª¨ë“  í•™ìŠµ ê·œì¹™ì„ ì´ˆê¸°í™”í–ˆìŠµë‹ˆë‹¤.';
      }
      // custom rules match (latest first)
      const rules = getCustomRules();
      for(const r of rules.slice().reverse()){
        try{
          const p=(r.pattern||'').trim();
          let matched=false;
          if(/^\/.+\/[a-z]*$/i.test(p)){
            const last=p.lastIndexOf('/'); const body=p.slice(1,last); const flags=p.slice(last+1); const re=new RegExp(body,flags); matched=re.test(text);
          } else {
            matched = text.toLowerCase().includes(p.toLowerCase());
          }
          if(matched) return r.response;
        }catch{}
      }

      // small talk
      const isGreeting=/(hello|hi|hey|ì•ˆë…•|í•˜ì´|ã…ã…‡|ì•ˆë‡½)/i.test(text);
      const isThanks=/(thanks|thank|ê³ ë§ˆì›Œ|ê°ì‚¬|ë•¡í)/i.test(text);
      const isBye=/(bye|goodbye|ì˜ê°€|ì•ˆë…•íˆ|ã…‚ã…‡)/i.test(text);
      const isSorry=/(sorry|ë¯¸ì•ˆ|ì£„ì†¡)/i.test(text);
      const askName=/(ë„ˆ(ëŠ”)? ëˆ„êµ¬|who are you|your name|ì´ë¦„)/i.test(text);
      const askHelp=/(ë„ì›€|help|ë¬´ì—‡|ë­(í•´)?|í•  ìˆ˜)/i.test(text);
      const askTime=/(ì‹œê°„|time|ëª‡ì‹œ)/i.test(text);
      const askDate=/(ë‚ ì§œ|date|ë©°ì¹ )/i.test(text);
      if(isGreeting){ const h=now.getHours(); const part=h<5?'ê¹Šì€ ë°¤':h<11?'ì•„ì¹¨':h<14?'ì ì‹¬':h<18?'ì˜¤í›„':'ì €ë…'; return rnd([`ì•ˆë…•í•˜ì„¸ìš”! ${part}ì—” ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?`, `${part}ì´ì—ìš”. ë°˜ê°€ì›Œìš”! ì¼ì§€/ëª©í‘œ/ì¶”ì²œ ì¤‘ì—ì„œ ë¬´ì—‡ì´ í•„ìš”í•˜ì‹ ê°€ìš”?`, `ì•ˆë…•! ì˜¤ëŠ˜ ê¸°ë¶„ì€ ì–´ë– ì„¸ìš”? í•„ìš”í•˜ì‹œë©´ ëª©í‘œ í˜„í™©ì„ ìš”ì•½í•´ ë“œë¦´ê²Œìš”.`]) }
      if(isThanks){ return rnd(['ì²œë§Œì—ìš”! ë„ì›€ì´ ë˜ì—ˆë‹¤ë‹ˆ ê¸°ë»ìš” ğŸ™Œ','ì–¸ì œë“ ì§€ìš”! ë‹¤ë¥¸ ê²ƒë„ í•„ìš”í•˜ì‹œë©´ ë§ì”€í•´ ì£¼ì„¸ìš” ğŸ™‚','ë³„ë§ì”€ì„ìš”! ì˜¤ëŠ˜ë„ íŒŒì´íŒ…ì…ë‹ˆë‹¤ ğŸ’ª']) }
      if(isBye){ return rnd(['ì¢‹ì€ í•˜ë£¨ ë˜ì„¸ìš”! ë‹¤ìŒì— ë˜ ë§Œë‚˜ìš” ğŸ‘‹','ì•ˆë…•íˆ ê°€ì„¸ìš”! ë‚´ì¼ë„ ë©‹ì§„ ì„±ê³¼ ê¸°ëŒ€í• ê²Œìš” âœ¨','ë˜ í•„ìš”í•˜ì‹œë©´ ë¶ˆëŸ¬ì£¼ì„¸ìš”. ë°”ì´!']) }
      if(isSorry){ return rnd(['ê´œì°®ì•„ìš”! í•¨ê»˜ í•´ê²°í•´ë´ìš” ğŸ™‚','ë¬¸ì œì—†ìŠµë‹ˆë‹¤. ì–´ë””ë¶€í„° ë„ì™€ë“œë¦´ê¹Œìš”?','ì‚¬ê³¼í•˜ì‹¤ í•„ìš” ì—†ì–´ìš”. ì§€ê¸ˆë¶€í„° ì°¨ê·¼íˆ í•´ë´ìš”!']) }
      if(askName){ return rnd(['ì €ëŠ” ë„¤ë¡œë´‡ì´ì—ìš”. ì„±ê³µì¼ì§€ì™€ ëª©í‘œ ê´€ë¦¬ë¥¼ ë„ì™€ë“œë ¤ìš” ğŸ¤–','ë„¤ë¡œë´‡ì…ë‹ˆë‹¤! ê°œë°œ/ëª©í‘œ/ì¼ì§€ì™€ ê´€ë ¨ëœ ì¼ì„ ë¹ ë¥´ê²Œ ë„ì™€ë“œë¦´ê²Œìš”.','ë„¤ë¡œë´‡ì´ë¼ê³  í•´ìš”. ë¬´ì—‡ì´ë“  í¸í•˜ê²Œ ë¬¼ì–´ë³´ì„¸ìš”!']) }
      if(askHelp){ return 'ì œê°€ í•  ìˆ˜ ìˆëŠ” ì¼ ì˜ˆì‹œ: "ìµœê·¼ ì¼ì§€ ìš”ì•½", "ëª©í‘œ í˜„í™©", "ì˜¤ëŠ˜ ì¼ì§€ ìƒì„±", "ë‹¤ìŒ í•  ì¼ ì¶”ì²œ". ì–´ë–¤ ê±¸ ë„ì™€ë“œë¦´ê¹Œìš”?' }
      if(askTime){ return `ì§€ê¸ˆ ì‹œê°„ì€ ${now.toLocaleTimeString('ko-KR',{hour:'2-digit',minute:'2-digit'})} ì…ë‹ˆë‹¤.` }
      if(askDate){ return `ì˜¤ëŠ˜ ë‚ ì§œëŠ” ${now.toLocaleDateString('ko-KR',{year:'numeric',month:'long',day:'numeric',weekday:'long'})} ì…ë‹ˆë‹¤.` }

      // diary/goal helpers
      const formatDate = (d)=>{ try { return new Date(d).toLocaleDateString('ko-KR') } catch { return d } };
      if(lower.includes('ì¼ì§€') || lower.includes('diary')){
        if(lower.includes('ìš”ì•½')){
          if(!diaries.length) return 'ì•„ì§ ì‘ì„±ëœ ì¼ì§€ê°€ ì—†ì–´ìš”. "ì¼ì§€ ì‘ì„±"ì„ ë¨¼ì € í•´ë³¼ê¹Œìš”?';
          const lines = diaries.slice(0,5).map(d=>`- ${formatDate(d.date)}: ${d.title}`);
          return `ìµœê·¼ ì¼ì§€ ìš”ì•½ì…ë‹ˆë‹¤:\n${lines.join('\n')}\n\níŠ¹ì • ë‚ ì§œë‚˜ ì œëª©ìœ¼ë¡œ ìì„¸íˆ ë³´ê³  ì‹¶ìœ¼ë©´ ë§ì”€í•´ ì£¼ì„¸ìš”.`;
        }
        if(lower.includes('ìƒì„±') || lower.includes('ì‘ì„±')){
          const exists = diaries.some(d=>d.date===todayStr);
          if(exists) return 'ì˜¤ëŠ˜ ì¼ì§€ëŠ” ì´ë¯¸ ìˆì–´ìš”! ë‚´ìš©ì„ ì—…ë°ì´íŠ¸í•˜ê±°ë‚˜ ìƒˆë¡œìš´ ëª©í‘œë¥¼ ì¶”ê°€í•´ë³´ëŠ” ê±´ ì–´ë–¨ê¹Œìš”?';
          return 'ì˜¤ëŠ˜ì˜ ì¼ì§€ ì´ˆì•ˆì„ ìë™ìœ¼ë¡œ ì±„ì›Œë‘ì—ˆì–´ìš”. ë©”ì¸ ì•±ì—ì„œ í™•ì¸ í›„ ì €ì¥í•´ ì£¼ì„¸ìš”!';
        }
      }
      if(lower.includes('ëª©í‘œ') || lower.includes('goal')){
        if(!goals.length) return 'ì•„ì§ ì„¤ì •ëœ ëª©í‘œê°€ ì—†ì–´ìš”. ìš°ì¸¡ ìƒë‹¨ì˜ "ìƒˆ ëª©í‘œ ì¶”ê°€"ë¡œ ì‹œì‘í•´ ë³´ì„¸ìš”!';
        const completed = goals.filter(g=>g.status==='completed');
        const pending = goals.filter(g=>g.status!=='completed');
        const cl = completed.slice(0,5).map(g=>`- âœ… ${g.title} (ê¸°í•œ: ${formatDate(g.deadline)})`);
        const pl = pending.slice(0,5).map(g=>`- â³ ${g.title} (ê¸°í•œ: ${formatDate(g.deadline)})`);
        return `ëª©í‘œ í˜„í™©ì…ë‹ˆë‹¤:\n\nì™„ë£Œ(${completed.length})\n${cl.join('\n') || '- ì—†ìŒ'}\n\nì§„í–‰ì¤‘(${pending.length})\n${pl.join('\n') || '- ì—†ìŒ'}`;
      }

      return 'í˜„ì¬ëŠ” ë¡œì»¬ ì–´ì‹œìŠ¤í„´íŠ¸ ëª¨ë“œì…ë‹ˆë‹¤. ì˜ˆ: "ìµœê·¼ ì¼ì§€ ìš”ì•½", "ëª©í‘œ í˜„í™©", "ë‹¤ìŒ í•  ì¼ ì¶”ì²œ" ê°™ì€ ìš”ì²­ì„ í•´ë³´ì„¸ìš”.';
    }

    async function fetchNeroResponsePopup(userMessage){
      const provider = (localStorage.getItem('ai_provider')||'local').toLowerCase();
      if(provider==='proxy'){
        const url = localStorage.getItem('ai_proxy_url');
        if(!url) return '[ì„¤ì • í•„ìš”] í”„ë¡ì‹œ URLì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ì–´ìš”.';
        try{
          const r = await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({inputs:userMessage})});
          const data = await r.json();
          if(!r.ok) throw new Error(data?.error||data?.message||`HTTP ${r.status}`);
          return data?.generated_text || data?.text || 'ì£„ì†¡í•´ìš”, ë‹µë³€ì„ ìƒì„±í•˜ì§€ ëª»í–ˆì–´ìš”.';
        }catch(e){
          return `í”„ë¡ì‹œ í†µì‹  ì˜¤ë¥˜: ${e?.message||e}`;
        }
      }
      return generateLocalAssistantResponse(userMessage);
    }

    // --- UI ---
    const msgs = document.getElementById('msgs');
    const inp = document.getElementById('inp');
    const send = document.getElementById('send');
    const closeBtn = document.getElementById('closeBtn');

    function addRow(text, who){
      const row = document.createElement('div');
      row.className = 'row ' + (who==='user'?'user':'bot');
      const bubble = document.createElement('div');
      bubble.className = 'bubble';
      bubble.innerHTML = (who==='bot'?'<i class="fas fa-robot"></i>':'<i class="fas fa-user"></i>') + (text||'');
      row.appendChild(bubble);
      msgs.appendChild(row);
      msgs.scrollTop = msgs.scrollHeight;
    }

    async function handleSend(){
      const text = inp.value.trim();
      if(!text) return;
      addRow(text,'user');
      inp.value = '';
      addRow('ë„¤ë¡œë´‡ì´ ìƒê° ì¤‘...','bot');
      const reply = await fetchNeroResponsePopup(text);
      // replace the last bot placeholder
      const botBubbles = msgs.querySelectorAll('.row.bot');
      if(botBubbles.length){ botBubbles[botBubbles.length-1].querySelector('.bubble').innerHTML = '<i class="fas fa-robot"></i>' + reply; }
    }

    send.addEventListener('click', handleSend);
    inp.addEventListener('keypress', (e)=>{ if(e.key==='Enter') handleSend(); });
    closeBtn.addEventListener('click', ()=> window.close());

    // focus input initially
    setTimeout(()=> inp.focus(), 200);
  </script>
</body>
</html>
